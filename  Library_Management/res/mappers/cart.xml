<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cart">

		



<select id="cartList" resultType="map">
    SELECT 
      TO_CHAR(LOAN_DATE, 'MM') AS MONTHNO,
      COUNT(*) AS TOTALLOANS,
      SUM(CASE WHEN RETURN_DATE IS NOT NULL 
          THEN 1 ELSE 0 END) AS TOTALRETURNS,
      SUM(CASE WHEN RETURN_DATE IS NULL 
          THEN 1 ELSE 0 END) AS NOTRETURNED,
      SUM(CASE WHEN RETURN_DATE IS NOT NULL 
           AND RETURN_DATE &lt;= DUE_DATE 
          THEN 1 ELSE 0 END) AS ONTIMERETURNS,
      SUM(CASE WHEN RETURN_DATE IS NOT NULL 
           AND RETURN_DATE &gt; DUE_DATE 
          THEN 1 ELSE 0 END) AS OVERDUERETURNS
    FROM BOOK_LOANS
    WHERE LOAN_DATE IS NOT NULL
    GROUP BY TO_CHAR(LOAN_DATE, 'MM')
    ORDER BY TO_CHAR(LOAN_DATE, 'MM')
</select>

<select id="getOverallStats" resultType="map">
	SELECT 
      COUNT(*) AS TOTALLOANS,
      SUM(CASE WHEN RETURN_DATE IS NOT NULL THEN 1 ELSE 0 END) AS TOTALRETURNS,
      SUM(CASE WHEN RETURN_DATE IS NULL THEN 1 ELSE 0 END) AS NOTRETURNED,
      SUM(CASE WHEN RETURN_DATE IS NOT NULL AND RETURN_DATE &lt;= DUE_DATE THEN 1 ELSE 0 END) AS ONTIMERETURNS,
      SUM(CASE WHEN RETURN_DATE IS NOT NULL AND RETURN_DATE &gt; DUE_DATE THEN 1 ELSE 0 END) AS OVERDUERETURNS
    FROM BOOK_LOANS
</select>
	

<select id="cartListMap" resultType="map">
    SELECT 
      TO_CHAR(LOAN_DATE, 'MM') AS "MONTHNO",
      COUNT(*) AS "TOTALLOANS",
      SUM(CASE WHEN RETURN_DATE IS NOT NULL 
          THEN 1 ELSE 0 END) AS "TOTALRETURNS",
      SUM(CASE WHEN RETURN_DATE IS NULL 
          THEN 1 ELSE 0 END) AS "NOTRETURNED",
      SUM(CASE WHEN RETURN_DATE IS NOT NULL 
           AND RETURN_DATE &lt;= DUE_DATE 
          THEN 1 ELSE 0 END) AS "ONTIMERETURNS",
      SUM(CASE WHEN RETURN_DATE IS NOT NULL 
           AND RETURN_DATE &gt; DUE_DATE 
          THEN 1 ELSE 0 END) AS "OVERDUERETURNS"
    FROM BOOK_LOANS
    WHERE LOAN_DATE IS NOT NULL
    GROUP BY TO_CHAR(LOAN_DATE, 'MM')
    ORDER BY TO_CHAR(LOAN_DATE, 'MM')
</select>

<select id="getOverallStatsMap" resultType="map">
	SELECT 
      COUNT(*) AS "TOTALLOANS",
      SUM(CASE WHEN RETURN_DATE IS NOT NULL THEN 1 ELSE 0 END) AS "TOTALRETURNS",
      SUM(CASE WHEN RETURN_DATE IS NULL THEN 1 ELSE 0 END) AS "NOTRETURNED",
      SUM(CASE WHEN RETURN_DATE IS NOT NULL AND RETURN_DATE &lt;= DUE_DATE THEN 1 ELSE 0 END) AS "ONTIMERETURNS",
      SUM(CASE WHEN RETURN_DATE IS NOT NULL AND RETURN_DATE &gt; DUE_DATE THEN 1 ELSE 0 END) AS "OVERDUERETURNS"
    FROM BOOK_LOANS
</select>

<select id="popularBooks" resultType="map">
	SELECT 
	    B.BOOK_TITLE AS "BOOK_TITLE",
	    COUNT(*) AS "LOAN_COUNT"
	FROM BOOK_LOANS L
	JOIN REAL_BOOK R ON L.REAL_BOOK = R.REAL_BOOK
	JOIN BOOKS B ON R.BOOK_NO = B.BOOK_NO
	GROUP BY B.BOOK_TITLE
	ORDER BY LOAN_COUNT DESC
	FETCH FIRST 5 ROWS ONLY
</select>

<select id="categoryStats" resultType="map">
	SELECT 
	    C.CATEGORY_NAME AS "CATEGORY_NAME",
	    COUNT(*) AS "LOAN_COUNT"
	FROM BOOK_LOANS L
	JOIN REAL_BOOK R ON L.REAL_BOOK = R.REAL_BOOK
	JOIN BOOKS B ON R.BOOK_NO = B.BOOK_NO
	JOIN BOOK_CATEGORIES C ON B.CATEGORY_NO=C.CATEGORY_NO
	GROUP BY C.CATEGORY_NAME
</select>
	

</mapper>